#include <windows.h>
#include <stdio.h>
#include <tlhelp32.h>
#include <tchar.h>

void printError(TCHAR const* msg);

int main(){
    unsigned char shellcode[] ="";
    PROCESSENTRY32 pe32;
    DWORD pid;
    /*
    HANDLE CreateToolhelp32Snapshot(
    [in] DWORD dwFlags,
    [in] DWORD th32ProcessID
    );
    */
    HANDLE hsnapshot =  CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    if( hsnapshot == INVALID_HANDLE_VALUE ){
        printError(TEXT("CreateToolhelp32Snapshot (of processes)"));
        return 1;
    }
    /*
    BOOL Process32First(
    [in]      HANDLE           hSnapshot,
    [in, out] LPPROCESSENTRY32 lppe
    );
    */
    pe32.dwSize = sizeof(PROCESSENTRY32);
    if(!Process32First(hsnapshot, &pe32)){
        printError(TEXT("Process32First")); // show cause of failure
        CloseHandle(hsnapshot);          // clean the snapshot object
        return 1;
    }
    do{
        printf("ID: %ld Name: %s\n", pe32.th32ProcessID, pe32.szExeFile);
    } while(Process32Next(hsnapshot, &pe32));

    CloseHandle(hsnapshot);
    return 0;
}


void printError( TCHAR const* msg ){
    DWORD eNum;
    TCHAR sysMsg[256];
    TCHAR* p;
    eNum = GetLastError( );
    FormatMessage( FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS,
        NULL, eNum,
        MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), // Default language
        sysMsg, 256, NULL );
    p = sysMsg;
    while( ( *p > 31 ) || ( *p == 9 ) )++p;
    do { *p-- = 0; } while( ( p >= sysMsg ) && ( ( *p == '.' ) || ( *p < 33 ) ) );
    _tprintf( TEXT("\n  WARNING: %s failed with error %d (%s)"), msg, eNum, sysMsg );
    }